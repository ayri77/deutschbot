<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£—á–µ–±–Ω—ã–π —á–∞—Ç-–±–æ—Ç</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
</head>
<body>
    <h2>–ß–∞—Ç-–±–æ—Ç –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –Ω–µ–º–µ—Ü–∫–æ–≥–æ —è–∑—ã–∫–∞</h2>

    <div id="chat-container">
        <label for="topic">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É:</label>
        <select id="topic" onchange="loadLesson()">
            <option value="" selected disabled>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</option>
			<option value="A1.1. Eine Fahrkarte (ein Bahnticket) kaufen">A1.1. Eine Fahrkarte (ein Bahnticket) kaufen</option>
            <option value="A1.2. Timo¬¥s Freund Kurt und seine Freundin Anna. Das erste Treffen">A1.2. Timo¬¥s Freund Kurt und seine Freundin Anna. Das erste Treffen</option>
			<option value="Lektion 17. Timo und Anna">Lektion 17. Timo und Anna</option>
        </select>
		<div class="tab-container">
		  <button class="tab-button active" onclick="switchTab(event, 'lesson-tab')">üìñ –£—Ä–æ–∫</button>
		  <button class="tab-button" onclick="switchTab(event, 'chat-tab')">üí¨ –ß–∞—Ç-–±–æ—Ç</button>
		  <button class="tab-button" onclick="switchTab(event, 'test-tab')">üìù –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
		</div>

		<div id="lesson-tab" class="tab-content active">
		  <div id="lesson-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç —É—Ä–æ–∫–∞...</div>
		</div>

		<div id="chat-tab" class="tab-content">
		  <textarea id="question" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..."></textarea>
		  <button onclick="askChatGPT()">–°–ø—Ä–æ—Å–∏—Ç—å</button>
		  <div id="loading">‚è≥ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</div>
		  <div id="chatbox"></div>
		</div>

		<div id="test-tab" class="tab-content">
		  <button onclick="startTest()">–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç</button>
		  <div id="test-container"></div>
		</div>
				
    </div>

    <script>
		function switchTab(event, tab) {
			document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
			document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
			document.getElementById(tab).classList.add('active');
			event.currentTarget.classList.add('active');
		}
		function loadLesson() {
			let topic = document.getElementById("topic").value;
			let lessonText = document.getElementById("lesson-text");

			if (!topic) {
				lessonText.innerHTML = "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç —É—Ä–æ–∫–∞...";
				return;
			}

		fetch(`/lesson?topic=${topic}`)
			.then(response => response.text())
			.then(data => {
				lessonText.innerHTML = `<div style="padding: 15px; max-height: 500px; overflow: auto; border-radius: 8px; border: 2px solid #ffcc80; background: #fff8e1;">${data}</div>`; 
			});
		}
		
        function formatText(text) {
            return text.replace(/\n/g, "<br>");
        }		

		function addMessage(author, text) {
			let chatbox = document.getElementById("chatbox");
			let messageContainer = document.createElement("div");
			messageContainer.classList.add("message-container");

			let avatar = document.createElement("img");
			avatar.classList.add("avatar");

			let message = document.createElement("div");
			message.classList.add("message");

			if (author === "user") {
				message.classList.add("user-message");
				avatar.src = "https://cdn-icons-png.flaticon.com/512/3177/3177440.png"; // –ò–∫–æ–Ω–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
			} else {
				message.classList.add("bot-message");
				avatar.src = "https://cdn-icons-png.flaticon.com/512/4712/4712109.png"; // –ò–∫–æ–Ω–∫–∞ —á–∞—Ç–±–æ—Ç–∞
			}

			message.innerHTML = `<strong>${author === "user" ? "–í—ã:" : "–ë–æ—Ç:"}</strong> ${text}`;
			if (author === "user") {
				messageContainer.appendChild(message);
				messageContainer.appendChild(avatar);
			} else {
				messageContainer.appendChild(avatar);
				messageContainer.appendChild(message);
			}

			chatbox.appendChild(messageContainer);
			chatbox.scrollTop = chatbox.scrollHeight;
		}

		function askChatGPT() {
			let question = document.getElementById("question").value;
			let loading = document.getElementById("loading");

			if (!question.trim()) return;

			addMessage("user", question);
			document.getElementById("question").value = "";
			loading.style.display = "block";

			fetch("/ask", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ question: question })
			})
			.then(response => response.json())
			.then(data => {
				addMessage("bot", formatText(data.answer));
				loading.style.display = "none";
			});
		}
		
		function evaluateResponse() {
			let userAnswers = document.querySelectorAll("input[type='radio']:checked");
			let feedbackContainer = document.getElementById("feedback-container");
			feedbackContainer.innerHTML = ""; // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

			if (userAnswers.length === 0) {
				feedbackContainer.innerHTML = "<p style='color: red;'>–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞!</p>";
				return;
			}

			let results = [];
			userAnswers.forEach(answer => {
				let isCorrect = answer.getAttribute("data-correct") === "true";
				let resultText = isCorrect 
					? `<p style='color: green;'>‚úÖ ${answer.value} ‚Äì –í–µ—Ä–Ω–æ</p>`
					: `<p style='color: red;'>‚ùå ${answer.value} ‚Äì –ù–µ–≤–µ—Ä–Ω–æ</p>`;
				results.push(resultText);
			});

			feedbackContainer.innerHTML = results.join("");
		}		
		
		function startTest() {
			let topic = document.getElementById("topic").value;
			let testContainer = document.getElementById("test-container");
			let testLoading = document.getElementById("test-loading");
			
			if (!topic) {
				alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É!");
				return;
			}

			if (testLoading) testLoading.style.display = "block";
			testContainer.innerHTML = "";

			fetch(`/test?topic=${topic}`)
				.then(response => response.json())
				.then(data => {
					if (testLoading) testLoading.style.display = "none";
					if (data.error) {
						testContainer.innerHTML = `<p style='color: red;'>–û—à–∏–±–∫–∞: ${data.error}</p>`;
						return;
					}
					let testHTML = "<h3>–¢–µ—Å—Ç –ø–æ —Ç–µ–º–µ: " + topic + "</h3>";
					data.questions.forEach((q, index) => {
						testHTML += `<p>${index + 1}. ${q.question}</p>`;
						q.options.forEach(opt => {
							let isCorrect = (q.answer === opt) ? "true" : "false";
							testHTML += `<input type='radio' name='q${index}' value='${opt}' data-correct='${isCorrect}'> ${opt}<br>`;
						});
					});
					testHTML += "<button onclick='evaluateResponse()'>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç—ã</button>";
					testContainer.innerHTML = testHTML;
				})
				.catch(error => {
					if (testLoading) testLoading.style.display = "none";
					testContainer.innerHTML = `<p style='color: red;'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–∞: ${error.message}</p>`;
					console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Ç–µ—Å—Ç–∞:", error);
				});
		}
    </script>
	<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
</body>
</html>
